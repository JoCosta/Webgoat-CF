
pipeline {
    agent any

    environment {
        ARTEFACT_NAME = "${WORKSPACE}/target/WebGoat-${BUILD_VERSION}.war"
        BUILD_VERSION = 1
        IQ_SCAN_URL = ""

        // Amend these
        IQ_APPNAME = ""
        JENKINS_CREDS_ID = "Sonatype"
    }

    stages {
        stage('Build') {
            steps {
                sh 'mvn -B -Dproject.version=$BUILD_VERSION -Dmaven.test.failure.ignore clean package'
            }
            post {
                success {
                    echo 'Now archiving...'
                    archiveArtifacts artifacts: "**/target/*.war"
                }
            }
        }

        stage('Nexus IQ Scan'){
            steps {
                script{
                     nexusPolicyEvaluation( 
                                            failBuildOnNetworkError: true, 
                                            iqApplication: selectedApplication("${IQ_APPNAME}"), 
                                            iqScanPatterns: [[scanPattern: '**/*.war']], 
                                            iqStage: 'build', 
                                            jobCredentialsId: "${JENKINS_CREDS_ID}",
                                            callflow: [
                                                enable: true
                                            ]

                }
            }
        }
    }
}

